// Configuration
const CONFIG = {
  SHEET_ID: "12gdmHIP7c_3oE0EXxm21ax5Of4mljzo0RCxGAfmguvw", // 
  SHEET_NAME: "INVENTAIRE",
  API_KEY: "aziz", // Doit correspondre au frontend
  VERSION: "1.0"
};

// Initialisation
function init() {
  const ss = SpreadsheetApp.openById(CONFIG.SHEET_ID);
  const sheet = ss.getSheetByName(CONFIG.SHEET_NAME);
  
  // Crée l'en-tête si la feuille est vide
  if (sheet.getLastRow() === 0) {
    sheet.appendRow(["Timestamp", "Camion", "Code Pièce", "Description"]);
  }
  
  return sheet;
}

// Gestion des requêtes GET
function doGet(e) {
  const sheet = init();
  Logger.log(`GET Request: ${JSON.stringify(e)}`);

  try {
    validateRequest(e);
    
    if (e.parameter.action === "get-report") {
      validateReportParams(e.parameter);
      const data = getReportData(sheet, e.parameter.debut, e.parameter.fin);
      return createCsvResponse(data);
    }
    
    throw new Error("Action GET non valide. Attendu 'action=get-report'");
    
  } catch (error) {
    Logger.log(`doGet Error: ${error.message}`);
    return createErrorResponse(error.message);
  }
}

// Gestion des requêtes POST
function doPost(e) {
  const sheet = init();
  Logger.log(`POST Request: ${JSON.stringify(e)}`);

  try {
    validateRequest(e);
    const data = parsePostData(e);
    
    if (data.action === "add-item") {
      validateItemData(data);
      addItemToSheet(sheet, data);
      return createSuccessResponse("Pièce ajoutée avec succès");
    }
    
    throw new Error("Action POST non valide. Attendu 'action=add-item'");
    
  } catch (error) {
    Logger.log(`doPost Error: ${error.message}`);
    return createErrorResponse(error.message);
  }
}

// Fonctions utilitaires
function validateRequest(e) {
  if (!e.parameter || e.parameter.key !== CONFIG.API_KEY) {
    throw new Error("Clé API invalide");
  }
  
  if (e.parameter.v !== CONFIG.VERSION) {
    throw new Error(`Version API non supportée. Attendu: ${CONFIG.VERSION}`);
  }
}

function parsePostData(e) {
  if (!e.postData || !e.postData.contents) {
    throw new Error("Données POST manquantes");
  }
  
  try {
    return JSON.parse(e.postData.contents);
  } catch (error) {
    throw new Error("Format JSON invalide");
  }
}

function validateReportParams(params) {
  if (!params.debut || !params.fin) {
    throw new Error("Paramètres 'debut' et 'fin' requis");
  }
  
  const debut = parseDateSafe(params.debut);
  const fin = parseDateSafe(params.fin);
  
  if (debut > fin) {
    throw new Error("La date de début doit être antérieure à la date de fin");
  }
}

function validateItemData(data) {
  const required = ['camion', 'piece', 'description'];
  const missing = required.filter(field => !data[field]);
  
  if (missing.length > 0) {
    throw new Error(`Champs manquants: ${missing.join(', ')}`);
  }
  
  if (!/^CAM-\d{3}$/.test(data.camion)) {
    throw new Error("Format camion invalide (ex: CAM-001)");
  }
  
  if (!/^PCE-\d{4}-\d{3}$/.test(data.piece)) {
    throw new Error("Format pièce invalide (ex: PCE-2023-001)");
  }
  
  if (data.description.length < 5) {
    throw new Error("La description doit contenir au moins 5 caractères");
  }
}

function parseDateSafe(dateString) {
  const date = new Date(dateString);
  if (isNaN(date.getTime())) {
    throw new Error(`Date invalide: ${dateString}`);
  }
  return date;
}

function addItemToSheet(sheet, data) {
  const lock = LockService.getScriptLock();
  
  try {
    lock.waitLock(30000); // Attendre 30s max
    const timestamp = new Date();
    sheet.appendRow([timestamp, data.camion, data.piece, data.description]);
  } finally {
    lock.releaseLock();
  }
}

function getReportData(sheet, startDateString, endDateString) {
  const start = parseDateSafe(startDateString);
  const end = parseDateSafe(endDateString);
  end.setHours(23, 59, 59, 999);
  
  const lastRow = sheet.getLastRow();
  const lastCol = sheet.getLastColumn();
  const range = sheet.getRange(1, 1, lastRow, lastCol);
  const data = range.getDisplayValues();
  
  if (data.length <= 1) {
    return data[0] ? data[0].join(",") : "Timestamp,Camion,Code Pièce,Description";
  }

  const output = [];
  output.push(data[0].join(",")); // En-têtes

  for (let i = 1; i < data.length; i++) {
    const rowDate = new Date(data[i][0]);
    if (rowDate >= start && rowDate <= end) {
      output.push(data[i].map(formatCsvValue).join(","));
    }
  }

  return output.join("\n");
}

function formatCsvValue(value) {
  if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
    return `"${value.replace(/"/g, '""')}"`;
  }
  return value;
}

function createCsvResponse(data) {
  return ContentService
    .createTextOutput(data)
    .setMimeType(ContentService.MimeType.CSV);
}

function createSuccessResponse(message) {
  return ContentService
    .createTextOutput(JSON.stringify({
      status: "success",
      message: message
    }))
    .setMimeType(ContentService.MimeType.JSON);
}

function createErrorResponse(message) {
  return ContentService
    .createTextOutput(JSON.stringify({
      status: "error",
      message: message
    }))
    .setMimeType(ContentService.MimeType.JSON);
}
