<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Ajout Pi√®ce - iSpect</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial; margin: 2rem; }
    input, button { margin: 5px; padding: 8px; }
    label { display: block; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>Ajouter une pi√®ce √† inventaire_global.xlsx</h2>

  <label>üîê Token GitHub (une seule fois) :
    <input type="password" id="token" placeholder="Coller ici une fois" />
    <button onclick="sauverToken()">‚úÖ Sauver</button>
  </label>

  <label>üöö Camion : <input type="text" id="camion" value="Camion-1"></label>
  <label>üî© Code pi√®ce : <input type="text" id="piece"></label>
  <label>üë∑ Technicien : <input type="text" id="technicien" value="Technicien 1"></label>

  <button onclick="processus()">‚ûï Ajouter et envoyer</button>

  <pre id="log" style="margin-top: 20px; background:#f0f0f0; padding:10px;"></pre>

  <script>
    const username = "azizgouia123";
    const repo = "ispect";
    const filepath = "inventaire_global.xlsx";
    const branch = "main";

    function sauverToken() {
      const token = document.getElementById("token").value.trim();
      if (token) {
        localStorage.setItem("github_token", token);
        alert("Token sauvegard√© !");
      }
    }

    async function processus() {
      const token = localStorage.getItem("github_token");
      if (!token) return alert("Token manquant. Collez-le et cliquez sur ‚úÖ Sauver.");

      log("üîÑ T√©l√©chargement du fichier...");
      const sha = await getFileFromGitHub(token);
      if (!sha) return;

      ajouterNouvelleLigne();
      log("üì§ Envoi du fichier mis √† jour...");
      await envoyerFichier(token, sha);
    }

    function log(msg) {
      document.getElementById("log").textContent += msg + "\\n";
    }

    let lignes = [];

    async function getFileFromGitHub(token) {
      const url = `https://api.github.com/repos/${username}/${repo}/contents/${filepath}?ref=${branch}`;
      const res = await fetch(url, {
        headers: { Authorization: `token ${token}` }
      });
      if (!res.ok) {
        log("‚ùå Erreur d'acc√®s GitHub");
        return null;
      }
      const data = await res.json();
      const content = atob(data.content.replace(/\\n/g, ""));
      const binary = new Uint8Array([...content].map(c => c.charCodeAt(0)));
      const workbook = XLSX.read(binary, { type: "array" });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      lignes = XLSX.utils.sheet_to_json(sheet);
      return data.sha;
    }

    function ajouterNouvelleLigne() {
      const camion = document.getElementById("camion").value;
      const piece = document.getElementById("piece").value;
      const technicien = document.getElementById("technicien").value;
      if (!piece) return alert("Code pi√®ce vide.");

      const now = new Date();
      lignes.push({
        Date: now.toISOString().split("T")[0],
        Heure: now.toTimeString().slice(0, 5),
        Camion: camion,
        Pi√®ce: piece,
        Quantit√©: 1,
        Technicien: technicien
      });
    }

    async function envoyerFichier(token, sha) {
      const ws = XLSX.utils.json_to_sheet(lignes);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Inventaire");
      const wbout = XLSX.write(wb, { type: "binary", bookType: "xlsx" });
      const buffer = new Uint8Array(wbout.length);
      for (let i = 0; i < wbout.length; i++) buffer[i] = wbout.charCodeAt(i) & 0xff;
      const base64 = btoa(String.fromCharCode(...buffer));

      const payload = {
        message: "Ajout automatique de pi√®ce",
        content: base64,
        sha: sha,
        branch: branch
      };

      const res = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/${filepath}`, {
        method: "PUT",
        headers: {
          Authorization: `token ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      });

      if (res.ok) {
        log("‚úÖ Fichier mis √† jour sur GitHub !");
      } else {
        const err = await res.json();
        log("‚ùå Erreur : " + (err.message || "inconnue"));
      }
    }
  </script>
</body>
</html>
