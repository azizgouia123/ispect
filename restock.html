<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Test Upload vers GitHub</title>
</head>
<body>
  <h1>Envoyer un fichier Excel sur GitHub</h1>
  <input type="file" id="fileInput" accept=".xlsx" />
  <button onclick="uploadToGitHub()">Envoyer</button>

  <script>
    const GITHUB_TOKEN = "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"; // ⚠️ Test uniquement
    const USERNAME = "azizgouia123";
    const REPO = "ispect";
    const BRANCH = "main";
    const FILE_PATH = "inventaire_global.xlsx";

    async function uploadToGitHub() {
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];

      if (!file) {
        alert("Veuillez choisir un fichier.");
        return;
      }

      const reader = new FileReader();

      reader.onload = async function () {
        const base64Data = reader.result.split(',')[1]; // Enlève "data:application/...;base64,"

        const url = `https://api.github.com/repos/${USERNAME}/${REPO}/contents/${FILE_PATH}`;

        // Récupère le SHA actuel du fichier
        let sha = undefined;
        try {
          const res = await fetch(`${url}?ref=${BRANCH}`, {
            headers: {
              Authorization: `token ${GITHUB_TOKEN}`
            }
          });
          const data = await res.json();
          sha = data.sha;
        } catch (e) {
          console.warn("Fichier inexistant, il sera créé.");
        }

        // Envoi du fichier
        const res = await fetch(url, {
          method: "PUT",
          headers: {
            "Authorization": `token ${GITHUB_TOKEN}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            message: "Mise à jour automatique de inventaire_global.xlsx",
            content: base64Data,
            branch: BRANCH,
            ...(sha && { sha }) // Ajoute le SHA si fichier existait
          })
        });

        const result = await res.json();
        if (res.ok) {
          alert("✅ Fichier mis à jour sur GitHub !");
        } else {
          console.error(result);
          alert("❌ Erreur GitHub : " + result.message);
        }
      };

      reader.readAsDataURL(file);
    }
  </script>
</body>
</html>
