<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Ajouter des pièces à l'inventaire</title>
</head>
<body>
  <h2>Ajouter une pièce</h2>
  <input type="text" id="codePiece" placeholder="Entrez le code de la pièce" />
  <button onclick="ajouterPiece()">Ajouter</button>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    const GITHUB_TOKEN = "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"; // à utiliser seulement pour test
    const USERNAME = "azizgouia123";
    const REPO = "ispect";
    const BRANCH = "main";
    const FILE_PATH = "inventaire_global.xlsx";

    async function ajouterPiece() {
      const code = document.getElementById("codePiece").value.trim();
      if (!code) return alert("Code de pièce vide");

      const url = `https://api.github.com/repos/${USERNAME}/${REPO}/contents/${FILE_PATH}`;

      // Étape 1 : lire le fichier Excel actuel sur GitHub
      const getRes = await fetch(url, {
        headers: {
          Authorization: `token ${GITHUB_TOKEN}`
        }
      });

      if (!getRes.ok) {
        alert("Erreur de lecture : " + getRes.statusText);
        return;
      }

      const fileData = await getRes.json();
      const sha = fileData.sha;
      const content = atob(fileData.content.replace(/\n/g, ""));
      const workbook = XLSX.read(content, { type: "binary" });

      // Étape 2 : ajouter le code dans une nouvelle ligne (feuille 1)
      const ws = workbook.Sheets[workbook.SheetNames[0]];
      const data = XLSX.utils.sheet_to_json(ws, { header: 1 });
      data.push([new Date().toLocaleString(), code]); // Date + code
      const newWs = XLSX.utils.aoa_to_sheet(data);
      const newWb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(newWb, newWs, "Feuille1");

      const wbout = XLSX.write(newWb, { type: "base64", bookType: "xlsx" });

      // Étape 3 : envoyer le fichier mis à jour sur GitHub
      const putRes = await fetch(url, {
        method: "PUT",
        headers: {
          Authorization: `token ${GITHUB_TOKEN}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          message: `Ajout de la pièce ${code}`,
          content: wbout,
          sha: sha,
          branch: BRANCH
        })
      });

      if (putRes.ok) {
        alert("✅ Pièce ajoutée !");
        document.getElementById("codePiece").value = "";
      } else {
        const err = await putRes.json();
        alert("❌ Erreur GitHub : " + (err.message || "inconnue"));
        console.error(err);
      }
    }
  </script>
</body>
</html>
